name: GitHub Push Notifier

on:
  push:
    branches:
      - '**'

jobs:
  notify:
    runs-on: 
      group: k23a
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install discord.js node-fetch dotenv

      - name: Send Discord notification
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
          GH_REPO: ${{ github.repository }}
          GH_BRANCH: ${{ github.ref_name }}
          GH_AUTHOR: ${{ github.event.pusher.name }}
          GH_COMMIT_MSG: ${{ github.event.head_commit.message }}
          GH_COMMIT_URL: ${{ github.event.head_commit.url }}
        run: |
          node -e '
          const { Client, GatewayIntentBits } = require("discord.js");
          const client = new Client({ intents: [GatewayIntentBits.Guilds] });

          client.once("ready", async () => {
            const channel = client.channels.cache.get(process.env.CHANNEL_ID);
            
            const message = `ðŸš¨ New Push to **${process.env.GH_REPO}** Branch **${process.env.GH_BRANCH}**!
          ðŸ‘¤ Author: **${process.env.GH_AUTHOR}**
          :pencil2: Commit: **${process.env.GH_COMMIT_MSG}**
          :broken_chain: View: ${process.env.GH_COMMIT_URL}`;

            if(channel) await channel.send(message);
            process.exit(0);
          });

          client.login(process.env.DISCORD_TOKEN);
          '