<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benchmark Performance Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        canvas {
            transition: height 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="p-6 max-w-7xl mx-auto">
    </div>

    <script>
        const state = {
            benchmarkData: null,
            selectedBranches: [],
            baseBranch: '',
            sortBy: 'absolute',
            showTop: 20,
            currentPage: 0,
            error: '',
        };

        let totalRuntimeChart = null;
        let queryPerformanceChart = null;

        const app = document.getElementById('app');


        function processData(json) {
            try {
                let data;
            
                if (json.executables && json.statistics) {
                    data = {
                        branches: json.executables,
                        statistics: json.statistics
                    };
                } else if (json.branches && json.statistics) {
                    data = json;
                } else {
                    throw new Error('Invalid benchmark JSON format. Must contain "branches"/"executables" and "statistics" fields.');
                }

                state.benchmarkData = data;
                state.selectedBranches = data.branches.slice(0, 2);
                state.baseBranch = data.branches[0];
                state.error = '';
                render();
            } catch (err) {
                state.error = `Error parsing JSON: ${err.message}`;
                state.benchmarkData = null;
                render();
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const json = JSON.parse(e.target.result);
                processData(json);
            };
            reader.readAsText(file);
        }
        
        async function loadDefaultData() {
            try {
                const response = await fetch('results.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const json = await response.json();
                processData(json);
            } catch (e) {
                console.info("Could not load default 'results.json'. Waiting for user upload.", e.message);
                render(); 
            }
        }

        function clearData() {
            state.benchmarkData = null;
            state.selectedBranches = [];
            state.baseBranch = '';
            state.error = '';
            state.currentPage = 0;
            render();
        }

        function toggleBranch(branch) {
            const index = state.selectedBranches.indexOf(branch);
            if (index > -1) {
                state.selectedBranches.splice(index, 1);
            } else {
                state.selectedBranches.push(branch);
            }
            render();
        }

        function getAnalysis() {
            if (!state.benchmarkData || state.selectedBranches.length === 0 || !state.baseBranch) return [];

            const baseStats = state.benchmarkData.statistics[state.baseBranch]?.per_query_stats;
            if (!baseStats) return [];

            const queries = Object.keys(baseStats);

            return queries.map(query => {
                const baseAvg = baseStats[query].average;
                const comparisons = {};

                state.selectedBranches.forEach(branch => {
                    if (branch !== state.baseBranch && state.benchmarkData.statistics[branch]?.per_query_stats[query]) {
                        const branchAvg = state.benchmarkData.statistics[branch].per_query_stats[query].average;
                        const diff = branchAvg - baseAvg;
                        const percentDiff = baseAvg === 0 ? (diff === 0 ? 0 : Infinity) : ((diff / baseAvg) * 100);

                        comparisons[branch] = {
                            value: branchAvg,
                            diff,
                            percentDiff,
                        };
                    }
                });

                return {
                    query,
                    base: baseAvg,
                    ...comparisons
                };
            });
        }

        function getTotalRuntimeComparison() {
            if (!state.benchmarkData || !state.baseBranch || !state.benchmarkData.statistics[state.baseBranch]) return null;

            const baseTotal = state.benchmarkData.statistics[state.baseBranch].total_runtime_stats.average;
            const comparisons = {};

            state.selectedBranches.forEach(branch => {
                if (branch !== state.baseBranch && state.benchmarkData.statistics[branch]) {
                    const branchTotal = state.benchmarkData.statistics[branch].total_runtime_stats.average;
                    comparisons[branch] = {
                        value: branchTotal,
                        diff: branchTotal - baseTotal,
                        percentDiff: baseTotal === 0 ? (branchTotal === 0 ? 0 : Infinity) : ((branchTotal - baseTotal) / baseTotal) * 100
                    };
                }
            });

            return { base: baseTotal, comparisons };
        }

        // --- RENDERING LOGIC ---

        function render() {
            if (!state.benchmarkData) {
                app.innerHTML = getUploadView();
                // Add event listener after rendering
                const fileInput = document.getElementById('file-upload');
                if (fileInput) {
                    fileInput.addEventListener('change', handleFileUpload);
                }
            } else {
                app.innerHTML = getAnalysisView();
                addAnalysisEventListeners();
                renderCharts();
            }
        }

        function getUploadView() {
            return `
                <div class="p-6 max-w-4xl mx-auto">
                    <h1 class="text-3xl font-bold mb-2">Benchmark Performance Analysis</h1>
                    <p class="text-gray-600 mb-6">Upload your benchmark JSON file to analyze performance differences</p>

                    ${state.error ? `<div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6 text-red-800">${state.error}</div>` : ''}

                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center hover:border-blue-500 transition-colors">
                        <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                        <label class="cursor-pointer">
                            <span class="text-blue-600 hover:text-blue-700 font-semibold">Click to upload</span>
                            <input id="file-upload" type="file" accept=".json" class="hidden" />
                        </label>
                        <p class="text-sm text-gray-500 mt-2">or drop a JSON benchmark results file</p>
                    </div>

                    <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="font-semibold mb-2">Expected JSON Format:</h3>
                        <pre class="text-xs bg-white p-3 rounded overflow-x-auto">
{
  "branches": ["branch1", "branch2", ...], // or "executables"
  "statistics": {
    "branch1": {
      "total_runtime_stats": { "average": 123456, ... },
      "per_query_stats": {
        "query1": { "average": 123, ... },
        ...
      }
    },
    ...
  }
}
                        </pre>
                    </div>
                </div>
            `;
        }

        function getAnalysisView() {
            const analysis = getAnalysis();
            const sortedAnalysis = [...analysis].sort((a, b) => {
                const getWorst = (item) => {
                    const comparisons = Object.keys(item).filter(k => k !== 'query' && k !== 'base');
                    if (comparisons.length === 0) return 0;
                    const values = comparisons.map(k => state.sortBy === 'absolute' ? item[k].diff : item[k].percentDiff);
                    return Math.max(0, ...values); // Use 0 if all are improvements
                };
                return getWorst(b) - getWorst(a);
            });
            const topQueries = sortedAnalysis.slice(0, state.showTop);
            const totalRuntimeComparison = getTotalRuntimeComparison();
            const totalPages = Math.ceil(sortedAnalysis.length / state.showTop);
            const startIndex = state.currentPage * state.showTop;
            const endIndex = startIndex + state.showTop;
            const paginatedQueries = sortedAnalysis.slice(startIndex, endIndex);

            const colors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];

            return `
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-3xl font-bold mb-2">Benchmark Performance Analysis</h1>
                        <p class="text-gray-600">Comparing multiple branches</p>
                    </div>
                    <button id="clear-data-btn" class="flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        Clear Data
                    </button>
                </div>

                <!-- Branch Selection -->
                <div class="bg-white border rounded-lg p-4 mb-6">
                    <h2 class="text-lg font-semibold mb-3">Branch Selection</h2>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Baseline Branch:</label>
                        <select id="base-branch-select" class="border rounded px-3 py-2 w-full max-w-md">
                            ${state.benchmarkData.branches.map(branch => `<option value="${branch}" ${state.baseBranch === branch ? 'selected' : ''}>${branch}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Compare With:</label>
                        <div id="toggle-branches" class="flex flex-wrap gap-2">
                            ${state.benchmarkData.branches.map(branch => `
                                <button data-branch="${branch}" class="px-3 py-1 rounded ${state.selectedBranches.includes(branch) ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'}">
                                    ${branch}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <!-- Total Runtime Comparison -->
                ${totalRuntimeComparison ? `
                <div class="bg-white border rounded-lg p-4 mb-6">
                    <h2 class="text-xl font-semibold mb-3">Total Runtime Comparison</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <div class="flex items-center justify-between p-2 bg-green-50 rounded">
                                <span class="font-semibold">${state.baseBranch} (baseline):</span>
                                <span>${totalRuntimeComparison.base.toFixed(2)}ms</span>
                            </div>
                            ${Object.entries(totalRuntimeComparison.comparisons).map(([branch, data]) => `
                                <div class="flex items-center justify-between p-2 rounded ${data.diff > 0 ? 'bg-red-50' : 'bg-green-50'}">
                                    <span class="font-semibold">${branch}:</span>
                                    <div class="text-right">
                                        <span class="mr-4">${data.value.toFixed(2)}ms</span>
                                        <span class="${data.diff > 0 ? 'text-red-600' : 'text-green-600'}">
                                            ${data.diff > 0 ? '+' : ''}${data.diff.toFixed(2)}ms
                                            (${data.diff > 0 ? '+' : ''}${data.percentDiff.toFixed(2)}%)
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div>
                            <canvas id="totalRuntimeChart"></canvas>
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- Controls -->
                <div class="flex justify-between items-end gap-4 mb-6">
                    <div class="flex gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Sort By:</label>
                            <select id="sort-by-select" class="border rounded px-3 py-2">
                                <option value="absolute" ${state.sortBy === 'absolute' ? 'selected' : ''}>Absolute Difference (ms)</option>
                                <option value="percent" ${state.sortBy === 'percent' ? 'selected' : ''}>Percent Difference (%)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Show Per Page:</label>
                            <select id="show-top-select" class="border rounded px-3 py-2">
                                <option value="10" ${state.showTop == 10 ? 'selected' : ''}>10</option>
                                <option value="20" ${state.showTop == 20 ? 'selected' : ''}>20</option>
                                <option value="30" ${state.showTop == 30 ? 'selected' : ''}>30</option>
                                <option value="50" ${state.showTop == 50 ? 'selected' : ''}>50</option>
                                <option value="${sortedAnalysis.length}" ${state.showTop == sortedAnalysis.length ? 'selected' : ''}>All (${sortedAnalysis.length})</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="prev-page-btn" class="px-3 py-1.5 border rounded bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" ${state.currentPage === 0 ? 'disabled' : ''}>
                            Previous
                        </button>
                        <span class="text-sm text-gray-600">Page ${state.currentPage + 1} of ${totalPages}</span>
                        <button id="next-page-btn" class="px-3 py-1.5 border rounded bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" ${state.currentPage >= totalPages - 1 ? 'disabled' : ''}>
                            Next
                        </button>
                    </div>
                </div>

                <!-- Chart -->
                <div class="bg-white border rounded-lg p-4 mb-6">
                    <h2 class="text-xl font-semibold mb-4">Query Performance Comparison</h2>
                    <div class="relative h-[400px]">
                        <canvas id="queryPerformanceChart"></canvas>
                    </div>
                </div>

                <!-- Detailed Table -->
                <div class="bg-white border rounded-lg overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Query</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold">${state.baseBranch} (ms)</th>
                                ${state.selectedBranches.filter(b => b !== state.baseBranch).map(branch => `
                                    <th class="px-4 py-3 text-right text-sm font-semibold">${branch} (ms)</th>
                                    <th class="px-4 py-3 text-right text-sm font-semibold">Î”</th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            ${paginatedQueries.map((item, idx) => `
                                <tr class="${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                    <td class="px-4 py-3 font-mono font-semibold">${item.query}</td>
                                    <td class="px-4 py-3 text-right">${item.base.toFixed(1)}</td>
                                    ${state.selectedBranches.filter(b => b !== state.baseBranch).map(branch => {
                                        const data = item[branch];
                                        if (!data) return `<td class="px-4 py-3 text-right text-gray-400">-</td><td class="px-4 py-3 text-right text-gray-400">-</td>`;
                                        return `
                                            <td class="px-4 py-3 text-right">${data.value.toFixed(1)}</td>
                                            <td class="px-4 py-3 text-right font-semibold ${data.diff > 0 ? 'text-red-600' : 'text-green-600'}">
                                                ${data.diff > 0 ? '+' : ''}${data.diff.toFixed(1)}
                                                <span class="text-xs ml-1">(${data.diff > 0 ? '+' : ''}${data.percentDiff.toFixed(1)}%)</span>
                                            </td>
                                        `;
                                    }).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function addAnalysisEventListeners() {
            document.getElementById('clear-data-btn').addEventListener('click', clearData);
            document.getElementById('base-branch-select').addEventListener('change', (e) => {
                state.baseBranch = e.target.value;
                render();
            });
            document.getElementById('toggle-branches').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    toggleBranch(e.target.dataset.branch);
                }
            });
            document.getElementById('sort-by-select').addEventListener('change', (e) => {
                state.sortBy = e.target.value;
                state.currentPage = 0;
                render();
            });
            document.getElementById('show-top-select').addEventListener('change', (e) => {
                state.showTop = Number(e.target.value);
                state.currentPage = 0;
                render();
            });
            document.getElementById('prev-page-btn').addEventListener('click', () => {
                if (state.currentPage > 0) {
                    state.currentPage--;
                    render();
                }
            });
            document.getElementById('next-page-btn').addEventListener('click', () => {
                state.currentPage++; 
                render();
            });
        }

        function renderCharts() {
            const colors = ['#6366f1', '#f43f5e', '#14b8a6', '#f59e0b', '#0ea5e9', '#d946ef']; 
            const baseColor = '#22c55e'; 

            // --- Total Runtime Chart ---
            const totalRuntimeComparison = getTotalRuntimeComparison();
            const totalRuntimeCtx = document.getElementById('totalRuntimeChart')?.getContext('2d');
            if (totalRuntimeCtx && totalRuntimeComparison) {
                const chartData = [
                    { branch: state.baseBranch, time: totalRuntimeComparison.base },
                    ...Object.entries(totalRuntimeComparison.comparisons).map(([branch, data]) => ({ branch, time: data.value }))
                ];

                if (totalRuntimeChart) totalRuntimeChart.destroy();
                totalRuntimeChart = new Chart(totalRuntimeCtx, {
                    type: 'bar',
                    data: {
                        labels: chartData.map(d => d.branch),
                        datasets: [{
                            label: 'Total Time (ms)',
                            data: chartData.map(d => d.time),
                            backgroundColor: chartData.map(d => d.branch === state.baseBranch ? baseColor : colors[state.selectedBranches.indexOf(d.branch) % colors.length]),
                            borderRadius: 4,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${context.raw.toFixed(2)} ms`
                                }
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: false,
                                title: { display: true, text: 'Total Time (ms)' }
                            }
                        }
                    }
                });
            }

            // --- Query Performance Chart ---
            const analysis = getAnalysis();
            const sortedAnalysis = [...analysis].sort((a, b) => {
                const getWorst = (item) => {
                    const comparisons = Object.keys(item).filter(k => k !== 'query' && k !== 'base');
                    if (comparisons.length === 0) return 0;
                    const values = comparisons.map(k => state.sortBy === 'absolute' ? item[k].diff : item[k].percentDiff);
                    return Math.max(0, ...values);
                };
                return getWorst(b) - getWorst(a);
            });
            const startIndex = state.currentPage * state.showTop;
            const endIndex = startIndex + state.showTop;
            const queriesForChart = sortedAnalysis.slice(startIndex, endIndex);

            const queryPerfCtx = document.getElementById('queryPerformanceChart')?.getContext('2d');

            if (queryPerfCtx && queriesForChart.length > 0) {
                const chartData = {
                    labels: queriesForChart.map(item => item.query),
                    datasets: state.selectedBranches.map((branch, idx) => ({
                        label: branch,
                        data: queriesForChart.map(item => {
                            if (branch === state.baseBranch) return item.base;
                            return item[branch] ? item[branch].value : null;
                        }),
                        backgroundColor: branch === state.baseBranch ? baseColor : colors[idx % colors.length],
                        borderRadius: 4,
                    }))
                };

                if (queryPerformanceChart) queryPerformanceChart.destroy();
                queryPerformanceChart = new Chart(queryPerfCtx, {
                    type: 'bar',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${context.dataset.label}: ${context.raw.toFixed(2)} ms`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Time (ms)' }
                            }
                        }
                    }
                });
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadDefaultData();
        });

    </script>
</body>
</html>